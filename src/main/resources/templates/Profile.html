<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | SFP Billing</title>
    <div th:replace="~{fragments/sidebar :: sidebar-css}"></div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
        }

        .main-content {
            background-color: #f8fafc;
            min-height: 100vh;
            padding: 2.5rem;
        }

        .profile-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .profile-header {
            background: white;
            border-radius: 32px;
            padding: 48px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 40px;
            margin-bottom: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .profile-avatar-wrapper {
            position: relative;
        }

        .profile-avatar {
            width: 160px;
            height: 160px;
            border-radius: 40px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            font-weight: 800;
            background-size: cover;
            background-position: center;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
        }

        .profile-info h1 {
            font-size: 2.25rem;
            font-weight: 800;
            color: #1e293b;
            letter-spacing: -0.025em;
            margin-bottom: 8px;
        }

        .profile-info p {
            font-size: 1.125rem;
            color: #64748b;
            font-weight: 500;
        }

        .role-pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 0.8125rem;
            font-weight: 800;
            margin-top: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .role-admin {
            background: #fff1f2;
            color: #e11d48;
            border: 1px solid #ffe4e6;
        }

        .role-client {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #dcfce7;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .detail-card {
            background: white;
            border-radius: 24px;
            padding: 24px 32px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.2s;
        }

        .detail-card:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
        }

        .detail-card label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .detail-card .value {
            font-size: 1.05rem;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-card i {
            color: #6366f1;
            width: 20px;
        }

        .actions-section {
            margin-top: 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .logout-btn {
            padding: 14px 40px;
            background: white;
            color: #ef4444;
            border: 2px solid #fee2e2;
            border-radius: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .logout-btn:hover {
            background: #fef2f2;
            border-color: #f87171;
            transform: translateY(-5px);
            box-shadow: 0 8px 15px -3px rgba(239, 68, 68, 0.1);
        }

        .edit-profile-btn {
            position: absolute;
            top: 48px;
            right: 48px;
            padding: 10px 20px;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .edit-profile-btn:hover {
            background: white;
            color: #6366f1;
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-card {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 24px;
            padding: 32px;
            position: relative;
            animation: modalSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalSlide {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 800;
            color: #1e293b;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .modal-footer {
            margin-top: 32px;
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            flex: 1;
            padding: 12px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-secondary {
            flex: 1;
            padding: 12px;
            background: #f1f5f9;
            color: #475569;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        .edit-image-btn {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 40px;
            height: 40px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .edit-image-btn:hover {
            color: var(--primary);
            border-color: var(--primary);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 24px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .back-btn:hover {
            color: #6366f1;
            transform: translateX(-4px);
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/sidebar :: sidebar(activePage='profile')}"></div>

    <div class="main-content">
        <div class="profile-container">
            <a href="/billing-app/api/Dashboard" class="back-btn">
                <i class="fa-solid fa-arrow-left"></i>
                Back to Overview
            </a>
            <div class="profile-container-inner" th:if="${user != null}">
                <div class="profile-header">
                    <button class="edit-profile-btn" onclick="openEditModal()">
                        <i class="fa-solid fa-pen-to-square"></i>
                        Edit Profile
                    </button>
                    <div class="profile-avatar-wrapper">
                        <div class="profile-avatar"
                            th:style="${user?.clientImage != null and user?.clientImage != '' ? 'background-image: url(' + user.clientImage + ')' : ''}"
                            th:text="${(user?.clientImage == null or user?.clientImage == '') ? 
                                       (user?.fullName != null and user?.fullName != '' ? #strings.substring(user.fullName, 0, 1).toUpperCase() : 
                                       (user?.username != null and user?.username != '' ? #strings.substring(user.username, 0, 1).toUpperCase() : 'U')) : ''}">
                        </div>
                        <label class="edit-image-btn" for="profileImageInput">
                            <i class="fa-solid fa-camera"></i>
                        </label>
                        <input type="file" id="profileImageInput" style="display: none;" accept="image/*">
                    </div>
                    <div class="profile-info">
                        <h1 th:text="${user?.fullName ?: 'User Profile'}">User Name</h1>
                        <p th:text="${user?.designation ?: 'Business Professional'}">Designation</p>
                        <div class="role-pill" th:classappend="${user?.role == 'ADMIN' ? 'role-admin' : 'role-client'}"
                            th:text="${user?.role ?: 'USER'}">CLIENT</div>
                    </div>
                </div>

                <div class="details-grid">
                    <div class="detail-card">
                        <label>Company Name</label>
                        <div class="value">
                            <i class="fa-solid fa-building"></i>
                            <span th:text="${user?.companyName ?: 'Not Provided'}">Acme Corp</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <label>Company Type</label>
                        <div class="value">
                            <i class="fa-solid fa-industry"></i>
                            <span th:text="${user?.companyType == 'Product' ? 'Product Based (D2C / Brand)' : 
                                            user?.companyType == 'Service' ? 'Service Based (Agency / Consulting)' : 
                                            user?.companyType == 'Retail' ? 'Retail / Shop (B2C)' : 
                                            user?.companyType == 'Wholesale' ? 'Wholesale / Trading (B2B)' : 
                                            user?.companyType == 'Manufacturing' ? 'Manufacturing / Industrial' : 
                                            user?.companyType == 'Hybrid' ? 'Hybrid (Combination of Both)' : 
                                            (user?.companyType ?: 'Not Specified')}">Product</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <label>Email Address</label>
                        <div class="value">
                            <i class="fa-solid fa-envelope"></i>
                            <span th:text="${user?.email}">user@example.com</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <label>Phone Number</label>
                        <div class="value">
                            <i class="fa-solid fa-phone"></i>
                            <span th:text="${user?.mobileNumber ?: 'N/A'}">+91 99999 00000</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <label>Username (System ID)</label>
                        <div class="value">
                            <i class="fa-solid fa-id-badge"></i>
                            <span th:text="${user?.username ?: 'N/A'}">SFP_1234</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <label>Account Security</label>
                        <div class="value">
                            <i class="fa-solid fa-lock"></i>
                            <span>********</span>
                            <button
                                style="margin-left: auto; background: none; border: none; color: #6366f1; font-weight: 700; cursor: pointer; font-size: 0.8rem;"
                                onclick="openPassModal()">Update</button>
                        </div>
                    </div>
                    <div class="detail-card">
                        <label>Account Created</label>
                        <div class="value">
                            <i class="fa-solid fa-calendar-check"></i>
                            <span
                                th:text="${user?.createdAt != null ? #temporals.format(user.createdAt, 'dd MMM yyyy') : 'Recently'}">21
                                Feb 2026</span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <label>Secret Recovery Key</label>
                        <div class="value">
                            <i class="fa-solid fa-key"></i>
                            <span id="secretKeyDisplay">********</span>
                            <button id="viewSecretBtn"
                                style="margin-left: auto; background: none; border: none; color: #6366f1; font-weight: 700; cursor: pointer; font-size: 0.8rem;"
                                onclick="openVerifyModal()">View</button>
                        </div>
                    </div>
                    <div class="detail-card" th:if="${user?.role == 'CLIENT'}">
                        <label>Monthly Revenue Target</label>
                        <div class="value">
                            <i class="fa-solid fa-bullseye"></i>
                            <span
                                th:text="${'₹' + #numbers.formatDecimal(user?.monthlyTarget ?: 100000, 1, 'COMMA', 2, 'POINT')}">₹1,00,000.00</span>
                        </div>
                    </div>
                </div>

                <div class="actions-section">
                    <button class="logout-btn" onclick="confirmLogout()">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        Logout from System
                    </button>
                </div>
            </div>
        </div>

        <!-- User Not Found -->
        <div class="profile-container" th:if="${user == null}">
            <a href="/billing-app/api/Dashboard" class="back-btn">
                <i class="fa-solid fa-arrow-left"></i>
                Back to Overview
            </a>
            <div class="profile-header" style="text-align: center; flex-direction: column;">
                <i class="fa-solid fa-user-slash" style="font-size: 3rem; color: #94a3b8; margin-bottom: 20px;"></i>
                <h2>User Not Found</h2>
                <p>We couldn't retrieve your profile information. Please try logging in again.</p>
                <a href="/billing-app/api/Login" class="role-pill"
                    style="text-decoration: none; margin-top: 20px;">Return to Login</a>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2>Edit Details</h2>
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="editFullName" th:value="${user?.fullName}">
            </div>
            <div class="form-group">
                <label>Designation</label>
                <input type="text" id="editDesignation" th:value="${user?.designation ?: 'Professional'}">
            </div>
            <div class="form-group">
                <label>Company Name</label>
                <input type="text" id="editCompanyName" th:value="${user?.companyName}">
            </div>
            <div class="form-group">
                <label>Company Type</label>
                <select id="editCompanyType">
                    <option value="Product Based (D2C / Brand)"
                        th:selected="${user.companyType == 'Product' or user.companyType == 'Product Based (D2C / Brand)'}">
                        Product Based (D2C / Brand)
                    </option>
                    <option value="Service Based (Agency / Consulting)"
                        th:selected="${user.companyType == 'Service' or user.companyType == 'Service Based (Agency / Consulting)'}">
                        Service Based (Agency / Consulting)</option>
                    <option value="Retail / Shop (B2C)"
                        th:selected="${user.companyType == 'Retail' or user.companyType == 'Retail / Shop (B2C)'}">
                        Retail /
                        Shop (B2C)</option>
                    <option value="Wholesale / Trading (B2B)"
                        th:selected="${user.companyType == 'Wholesale' or user.companyType == 'Wholesale / Trading (B2B)'}">
                        Wholesale / Trading (B2B)
                    </option>
                    <option value="Manufacturing / Industrial"
                        th:selected="${user.companyType == 'Manufacturing' or user.companyType == 'Manufacturing / Industrial'}">
                        Manufacturing /
                        Industrial</option>
                    <option value="Hybrid (Combination of Both)"
                        th:selected="${user.companyType == 'Hybrid' or user.companyType == 'Hybrid (Combination of Both)'}">
                        Hybrid (Combination of Both)
                    </option>
                </select>
            </div>
            <div class="form-group">
                <label>Mobile Number</label>
                <input type="text" id="editMobile" th:value="${user?.mobileNumber}">
            </div>
            <div class="form-group" th:if="${user?.role == 'CLIENT'}">
                <label>Monthly Sales Target (₹)</label>
                <input type="number" id="editMonthlyTarget" th:value="${user?.monthlyTarget ?: 100000}">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModals()">Cancel</button>
                <button class="btn-primary" onclick="saveDetails()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Password Update Modal -->
    <div id="passModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2>Update Password</h2>
            </div>
            <div class="form-group">
                <label>Secret Security Key</label>
                <input type="password" id="secretKey" placeholder="Enter your secret key">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPass" placeholder="Enter new password">
            </div>
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPass" placeholder="Re-enter new password">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModals()">Cancel</button>
                <button class="btn-primary" onclick="updatePassword()">Update Password</button>
            </div>
        </div>
    </div>

    <!-- Verify Password Modal (to see Secret Key) -->
    <div id="verifyModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2>Security Check</h2>
                <p style="font-size: 0.85rem; color: #64748b; margin-top: 5px;">Enter your password to reveal the secret
                    recovery key.</p>
            </div>
            <div class="form-group">
                <label>Account Password</label>
                <input type="password" id="verifyPassInput" placeholder="Enter password">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModals()">Cancel</button>
                <button class="btn-primary" onclick="verifyAndReveal()">Reveal Key</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const userEmail = /*[[${user?.email}]]*/ '';
        let base64Image = /*[[${user?.clientImage}]]*/ null;

        function confirmLogout() {
            if (confirm("Are you sure you want to logout from SFP Billing?")) {
                // Clear client-side token storage
                localStorage.removeItem('jwtToken');
                document.cookie = "jwtToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                document.cookie = "jwt=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                // Hit the server logout endpoint (clears server-side cookie + redirects to Login)
                window.location.href = "/billing-app/api/logout";
            }
        }

        function openEditModal() { document.getElementById('editModal').style.display = 'flex'; }
        function openPassModal() { document.getElementById('passModal').style.display = 'flex'; }
        function openVerifyModal() { document.getElementById('verifyModal').style.display = 'flex'; }
        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
            document.getElementById('verifyPassInput').value = '';
        }

        async function verifyAndReveal() {
            const pass = document.getElementById('verifyPassInput').value;
            if (!pass) return;

            try {
                const res = await fetch('/billing-app/api/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, password: pass })
                });

                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('secretKeyDisplay').innerText = data.secretKey;
                    const btn = document.getElementById('viewSecretBtn');
                    btn.innerText = 'Hide';
                    btn.onclick = hideSecret;
                    closeModals();
                } else {
                    alert("Incorrect password. Verification failed.");
                }
            } catch (err) {
                alert("Security verification failed.");
            }
        }

        function hideSecret() {
            document.getElementById('secretKeyDisplay').innerText = '********';
            const btn = document.getElementById('viewSecretBtn');
            btn.innerText = 'View';
            btn.onclick = openVerifyModal;
        }

        async function updatePassword() {
            const secret = document.getElementById('secretKey').value;
            const newP = document.getElementById('newPass').value;
            const confP = document.getElementById('confirmPass').value;

            if (newP !== confP) {
                alert("Passwords do not match!");
                return;
            }

            try {
                const res = await fetch('/billing-app/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: userEmail,
                        secretKey: secret,
                        newPassword: newP
                    })
                });

                if (res.ok) {
                    alert("Password updated successfully!");
                    closeModals();
                    location.reload();
                } else {
                    const msg = await res.text();
                    alert("Error: " + msg);
                }
            } catch (err) {
                alert("Failed to update password.");
            }
        }

        async function saveDetails() {
            const payload = {
                email: userEmail,
                fullName: document.getElementById('editFullName').value,
                designation: document.getElementById('editDesignation').value,
                companyName: document.getElementById('editCompanyName').value,
                companyType: document.getElementById('editCompanyType').value,
                mobileNumber: document.getElementById('editMobile').value,
                monthlyTarget: document.getElementById('editMonthlyTarget').value,
                clientImage: base64Image
            };

            try {
                const res = await fetch('/billing-app/api/update-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("Profile updated successfully!");
                    location.reload();
                } else {
                    const data = await res.json();
                    alert("Update failed: " + (data.message || "Unknown error"));
                }
            } catch (err) {
                alert("An error occurred while saving profile.");
            }
        }

        const imageInput = document.getElementById('profileImageInput');
        imageInput.addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function (event) {
                base64Image = event.target.result;
                document.querySelector('.profile-avatar').style.backgroundImage = `url(${base64Image})`;
                document.querySelector('.profile-avatar').innerText = '';
                saveDetails();
            };
            reader.readAsDataURL(file);
        });
    </script>
</body>

</html>